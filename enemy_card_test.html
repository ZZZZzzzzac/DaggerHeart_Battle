<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>敌人卡片模块测试</title>
    <link rel="stylesheet" href="enemy_editor.css">
    <link rel="stylesheet" href="enemy_card.css">
</head>
<body class="demo-body">

    <div class="demo-header">
        <h1>敌人卡片模块演示</h1>
        <p>右键点击卡片可进行编辑。</p>
        <button id="add-random-btn" class="btn primary">随机添加一张卡片</button>
    </div>

    <div class="cards-container" id="cards-container">
        <!-- 卡片将在这里生成 -->
    </div>

    <!-- 编辑器模态框 -->
    <div id="editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            
            <!-- 嵌入 enemy_editor.html 的内容 -->
            <div class="editor-container">
                <form id="enemyForm">
                    <!-- 基本信息 -->
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name">名称</label>
                                <input type="text" id="name" name="名称" required>
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label for="tier">位阶</label>
                                <input type="text" id="tier" name="位阶" required>
                                <select class="dropdown-trigger" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                    <option value="" disabled selected></option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label for="category">种类</label>
                                <input type="text" id="category" name="种类">
                                <select id="category-select" class="dropdown-trigger" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                    <option value="" disabled selected></option>
                                    <option value="斗士">斗士</option>
                                    <option value="集群">集群</option>
                                    <option value="头目">头目</option>
                                    <option value="杂兵">杂兵</option>
                                    <option value="远程">远程</option>
                                    <option value="潜伏">潜伏</option>
                                    <option value="社交">社交</option>
                                    <option value="独狼">独狼</option>
                                    <option value="标准">标准</option>
                                    <option value="辅助">辅助</option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="form-group" style="flex: 0 0 auto;">
                                <button type="button" id="applyTemplateBtn" class="btn secondary" style="height: 100%; margin: 0; padding: 0 15px;">使用模板</button>
                            </div>
                        </div>
        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="intro">简介</label>
                                <input type="text" id="intro" name="简介" placeholder="对敌人的外观和举止的概述。">
                            </div>
                        </div>                
                        <div class="form-row">                    
                            <div class="form-group">
                                <label for="tactics">动机与战术</label>
                                <input type="text" id="tactics" name="动机与战术" placeholder="例如：饥饿、觅食">
                            </div>
                            <div class="form-group">
                                <label for="experiences">经历</label>
                                <input type="text" id="experiences" name="经历" placeholder="例如：疾行+2">
                            </div>
                        </div>
        
        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="difficulty">难度</label>
                                <input type="text" id="difficulty" name="难度">
                            </div>
                             <div class="form-group">
                                <label for="hp">生命点</label>
                                <input type="text" id="hp" name="生命点">
                            </div>
                            <div class="form-group">
                                <label for="stress">压力点</label>
                                <input type="text" id="stress" name="压力点">
                            </div>
                            <div class="form-group">
                                <label for="majorThreshold">阈值</label>
                                <input type="text" id="majorThreshold" name="重度伤害阈值" placeholder="重度">                        
                                <input type="text" id="severeThreshold" name="严重伤害阈值" placeholder="严重">
                            </div>
                        </div>
        
        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attackHit">攻击</label>
                                <input type="text" id="attackHit" name="攻击命中" placeholder="命中">
                            </div>
                            <div class="form-group">
                                <input type="text" id="attackWeapon" name="攻击武器" placeholder="武器">
                            </div>
                            <div class="form-group" style="position: relative;">
                                <input type="text" id="attackRange" name="攻击范围" placeholder="范围">
                                <select class="dropdown-trigger" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                    <option value="" disabled selected></option>
                                    <option value="近战">近战</option>
                                    <option value="邻近">邻近</option>
                                    <option value="近">近</option>
                                    <option value="远">远</option>
                                    <option value="极远">极远</option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="form-group">
                                <input type="text" id="attackDamage" name="攻击伤害" placeholder="伤害骰">
                            </div>
                            <div class="form-group" style="position: relative;">
                                <input type="text" id="attackAttr" name="攻击属性" placeholder="属性">
                                <select class="dropdown-trigger" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                    <option value="" disabled selected></option>
                                    <option value="物理">物理</option>
                                    <option value="魔法">魔法</option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                        </div>
                    </div>
        
                    <!-- 特性 -->
                    <div class="form-section">                
                        <div id="traitsContainer">
                            <!-- 特性条目将在这里动态生成 -->
                        </div>
                    </div>
        
                    <div class="form-actions">
                        <button type="button" id="addTraitBtn" class="btn secondary">+ 添加特性</button>
                        <button type="submit" class="btn primary">保存修改</button>
                        <button type="button" id="clearBtn" class="btn danger" style="display:none;">清空</button> <!-- 隐藏清空按钮 -->
                    </div>
                </form>
            </div>
            
            <!-- 特性模板 -->
            <template id="traitTemplate">
                <div class="trait-item">
                    <div class="form-row">
                        <div class="form-group" style="position: relative;">
                            <label>特性名称</label>
                            <input type="text" class="trait-name" name="特性名称" placeholder="特性名称" required>
                            <select class="dropdown-trigger trait-name-select">
                                <option value="" disabled selected></option>
                            </select>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="form-group" style="position: relative;">
                            <label>特性类型</label>
                            <input type="text" class="trait-type" name="特性类型" placeholder="被动/动作/反应">
                            <select class="dropdown-trigger" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                <option value="" disabled selected></option>
                                <option value="被动">被动</option>
                                <option value="动作">动作</option>
                                <option value="反应">反应</option>
                            </select>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <button type="button" class="btn-icon remove-trait" title="删除">×</button>
                    </div>
                    <div class="form-group">
                        <label>特性描述</label>
                        <textarea class="trait-desc" name="特性描述" rows="2" placeholder="特性描述"></textarea>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="敌人数据块.js"></script>
    <script src="enemy_card.js"></script>
    <script src="enemy_editor.js"></script>
    <script>
        // 1. 初始化
        const cardsContainer = document.getElementById('cards-container');
        const modal = document.getElementById('editor-modal');
        const closeModal = document.querySelector('.close-modal');
        const addRandomBtn = document.getElementById('add-random-btn');
        const enemyForm = document.getElementById('enemyForm');
        
        let currentEditingCard = null; // 当前正在编辑的卡片 DOM 元素
        let currentEditingData = null; // 当前正在编辑的数据对象

        // 2. 随机添加卡片
        addRandomBtn.addEventListener('click', () => {
            if (typeof ADVERSARY !== 'undefined' && ADVERSARY.length > 0) {
                const randomIndex = Math.floor(Math.random() * ADVERSARY.length);
                const randomEnemy = JSON.parse(JSON.stringify(ADVERSARY[randomIndex])); // 深拷贝
                const card = renderEnemyCard(randomEnemy);
                cardsContainer.appendChild(card);
            } else {
                alert('未找到敌人数据 (ADVERSARY)');
            }
        });

        // 初始化加载几个
        if (typeof ADVERSARY !== 'undefined') {
             for(let i=0; i<3; i++) {
                 addRandomBtn.click();
             }
        }

        // 3. 处理编辑事件
        document.addEventListener('edit-enemy', (e) => {
            const { enemyData, cardElement } = e.detail;
            currentEditingData = enemyData;
            currentEditingCard = cardElement;
            
            fillEditor(enemyData);
            modal.style.display = 'block';
        });

        // 4. 关闭模态框
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // 5. 填充编辑器逻辑
        function fillEditor(data) {
            document.getElementById('name').value = data['名称'] || '';
            document.getElementById('tier').value = data['位阶'] || '';
            document.getElementById('category').value = data['种类'] || '';
            document.getElementById('intro').value = data['简介'] || '';
            document.getElementById('tactics').value = data['动机与战术'] || '';
            document.getElementById('experiences').value = data['经历'] || '';
            document.getElementById('difficulty').value = data['难度'] || '';
            document.getElementById('hp').value = data['生命点'] || '';
            document.getElementById('stress').value = data['压力点'] || '';
            document.getElementById('majorThreshold').value = data['重度伤害阈值'] || '';
            document.getElementById('severeThreshold').value = data['严重伤害阈值'] || '';
            document.getElementById('attackHit').value = data['攻击命中'] || '';
            document.getElementById('attackWeapon').value = data['攻击武器'] || '';
            document.getElementById('attackRange').value = data['攻击范围'] || '';
            document.getElementById('attackDamage').value = data['攻击伤害'] || '';
            document.getElementById('attackAttr').value = data['攻击属性'] || '';

            // 特性
            const traitsContainer = document.getElementById('traitsContainer');
            const addTraitBtn = document.getElementById('addTraitBtn');
            
            traitsContainer.innerHTML = '';
            
            if (data['特性']) {
                data['特性'].forEach(trait => {
                    addTraitBtn.click(); 
                    // 获取刚添加的元素 (最后一个)
                    const items = traitsContainer.querySelectorAll('.trait-item');
                    const newItem = items[items.length - 1];
                    
                    if (newItem) {
                        newItem.querySelector('.trait-name').value = trait['名称'] || '';
                        newItem.querySelector('.trait-type').value = trait['类型'] || '';
                        newItem.querySelector('.trait-desc').value = trait['特性描述'] || '';
                    }
                });
            }
        }

        // 6. 保存修改 (覆盖 submit)
        enemyForm.addEventListener('submit', (e) => {
            // e.preventDefault() 在 enemy_editor.js 中已经被调用了，但这里为了确保逻辑正确，不依赖它的顺序
            // 我们需要获取表单数据并更新 currentEditingData
            
            if (!currentEditingData || !currentEditingCard) return;

            const formData = new FormData(enemyForm);
            
            // 更新数据对象
            currentEditingData['名称'] = formData.get('名称');
            currentEditingData['位阶'] = formData.get('位阶');
            currentEditingData['种类'] = formData.get('种类');
            currentEditingData['简介'] = formData.get('简介');
            currentEditingData['动机与战术'] = formData.get('动机与战术');
            currentEditingData['经历'] = formData.get('经历');
            currentEditingData['难度'] = formData.get('难度');
            currentEditingData['生命点'] = formData.get('生命点');
            currentEditingData['压力点'] = formData.get('压力点');
            currentEditingData['重度伤害阈值'] = formData.get('重度伤害阈值');
            currentEditingData['严重伤害阈值'] = formData.get('严重伤害阈值');
            currentEditingData['攻击命中'] = formData.get('攻击命中');
            currentEditingData['攻击武器'] = formData.get('攻击武器');
            currentEditingData['攻击范围'] = formData.get('攻击范围');
            currentEditingData['攻击伤害'] = formData.get('攻击伤害');
            currentEditingData['攻击属性'] = formData.get('攻击属性');

            // 更新特性
            currentEditingData['特性'] = [];
            const traitItems = document.getElementById('traitsContainer').querySelectorAll('.trait-item');
            traitItems.forEach(item => {
                const name = item.querySelector('.trait-name').value;
                if (name) {
                    currentEditingData['特性'].push({
                        '名称': name,
                        '类型': item.querySelector('.trait-type').value,
                        '特性描述': item.querySelector('.trait-desc').value
                    });
                }
            });

            // 重新渲染卡片
            // 简单粗暴的方法：创建一个新卡片替换旧卡片
            const newCard = renderEnemyCard(currentEditingData);
            cardsContainer.replaceChild(newCard, currentEditingCard);
            
            // 更新引用
            currentEditingCard = newCard;

            modal.style.display = 'none';
        });

    </script>
</body>
</html>
