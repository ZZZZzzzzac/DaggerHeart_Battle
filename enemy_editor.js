const ENEMY_TEMPLATES = {
    "斗士": {
        "1": { "难度": "13", "攻击命中": "+1", "生命点": "6", "压力点": "3", "重度伤害阈值": "8", "严重伤害阈值": "16", "攻击伤害": "1d12+2" },
        "2": { "难度": "15", "攻击命中": "+2", "生命点": "9", "压力点": "5", "重度伤害阈值": "11", "严重伤害阈值": "26", "攻击伤害": "2d12+3" },
        "3": { "难度": "17", "攻击命中": "+4", "生命点": "9", "压力点": "5", "重度伤害阈值": "20", "严重伤害阈值": "37", "攻击伤害": "3d12+1" },
        "4": { "难度": "19", "攻击命中": "+6", "生命点": "9", "压力点": "5", "重度伤害阈值": "27", "严重伤害阈值": "67", "攻击伤害": "4d12+15" }
    },
    "集群": {
        "1": { "难度": "11", "攻击命中": "-1", "生命点": "5", "压力点": "2", "重度伤害阈值": "7", "严重伤害阈值": "10", "攻击伤害": "1d12+1" },
        "2": { "难度": "13", "攻击命中": "0", "生命点": "5", "压力点": "2", "重度伤害阈值": "12", "严重伤害阈值": "18", "攻击伤害": "2d12+3" },
        "3": { "难度": "15", "攻击命中": "+1", "生命点": "6", "压力点": "3", "重度伤害阈值": "20", "严重伤害阈值": "29", "攻击伤害": "3d12" },
        "4": { "难度": "17", "攻击命中": "+2", "生命点": "7", "压力点": "4", "重度伤害阈值": "25", "严重伤害阈值": "40", "攻击伤害": "4d12+10" }
    },
    "头目": {
        "1": { "难度": "14", "攻击命中": "+3", "生命点": "6", "压力点": "3", "重度伤害阈值": "10", "严重伤害阈值": "14", "攻击伤害": "1d12+1" },
        "2": { "难度": "16", "攻击命中": "+4", "生命点": "9", "压力点": "4", "重度伤害阈值": "13", "严重伤害阈值": "26", "攻击伤害": "2d12+1" },
        "3": { "难度": "18", "攻击命中": "+6", "生命点": "9", "压力点": "5", "重度伤害阈值": "21", "严重伤害阈值": "39", "攻击伤害": "3d10+1" },
        "4": { "难度": "20", "攻击命中": "+9", "生命点": "9", "压力点": "7", "重度伤害阈值": "35", "严重伤害阈值": "65", "攻击伤害": "4d12+6" }
    },
    "杂兵": {
        "1": { "难度": "11", "攻击命中": "-1", "生命点": "1", "压力点": "1", "重度伤害阈值": "-", "严重伤害阈值": "-", "攻击伤害": "2" },
        "2": { "难度": "13", "攻击命中": "0", "生命点": "1", "压力点": "1", "重度伤害阈值": "-", "严重伤害阈值": "-", "攻击伤害": "3" },
        "3": { "难度": "15", "攻击命中": "+1", "生命点": "1", "压力点": "1", "重度伤害阈值": "-", "严重伤害阈值": "-", "攻击伤害": "6" },
        "4": { "难度": "17", "攻击命中": "+2", "生命点": "1", "压力点": "2", "重度伤害阈值": "-", "严重伤害阈值": "-", "攻击伤害": "11" }
    },
    "远程": {
        "1": { "难度": "11", "攻击命中": "+1", "生命点": "3", "压力点": "2", "重度伤害阈值": "4", "严重伤害阈值": "7", "攻击伤害": "1d12+1" },
        "2": { "难度": "14", "攻击命中": "+3", "生命点": "4", "压力点": "2", "重度伤害阈值": "6", "严重伤害阈值": "14", "攻击伤害": "2d12+1" },
        "3": { "难度": "16", "攻击命中": "+5", "生命点": "5", "压力点": "3", "重度伤害阈值": "13", "严重伤害阈值": "27", "攻击伤害": "3d10+1" },
        "4": { "难度": "18", "攻击命中": "+6", "生命点": "5", "压力点": "4", "重度伤害阈值": "21", "严重伤害阈值": "35", "攻击伤害": "4d12+6" }
    },
    "潜伏": {
        "1": { "难度": "11", "攻击命中": "+1", "生命点": "3", "压力点": "2", "重度伤害阈值": "6", "严重伤害阈值": "6", "攻击伤害": "1d8+3" },
        "2": { "难度": "13", "攻击命中": "+3", "生命点": "4", "压力点": "3", "重度伤害阈值": "8", "严重伤害阈值": "18", "攻击伤害": "2d8+3" },
        "3": { "难度": "15", "攻击命中": "+5", "生命点": "5", "压力点": "4", "重度伤害阈值": "16", "严重伤害阈值": "29", "攻击伤害": "3d8+4" },
        "4": { "难度": "17", "攻击命中": "+6", "生命点": "5", "压力点": "5", "重度伤害阈值": "21", "严重伤害阈值": "40", "攻击伤害": "4d12+10" }
    },
    "独狼": {
        "1": { "难度": "14", "攻击命中": "+3", "生命点": "8", "压力点": "3", "重度伤害阈值": "10", "严重伤害阈值": "14", "攻击伤害": "1d20" },
        "2": { "难度": "16", "攻击命中": "+3", "生命点": "8", "压力点": "4", "重度伤害阈值": "13", "严重伤害阈值": "26", "攻击伤害": "2d20+3" },
        "3": { "难度": "18", "攻击命中": "+6", "生命点": "11", "压力点": "5", "重度伤害阈值": "21", "严重伤害阈值": "35", "攻击伤害": "3d20" },
        "4": { "难度": "20", "攻击命中": "+8", "生命点": "11", "压力点": "7", "重度伤害阈值": "35", "严重伤害阈值": "65", "攻击伤害": "4d12+15" }
    },
    "标准": {
        "1": { "难度": "12", "攻击命中": "+1", "生命点": "4", "压力点": "3", "重度伤害阈值": "7", "严重伤害阈值": "5", "攻击伤害": "1d8+1" },
        "2": { "难度": "14", "攻击命中": "+2", "生命点": "5", "压力点": "3", "重度伤害阈值": "10", "严重伤害阈值": "18", "攻击伤害": "2d8+2" },
        "3": { "难度": "16", "攻击命中": "+3", "生命点": "5", "压力点": "4", "重度伤害阈值": "17", "严重伤害阈值": "29", "攻击伤害": "3d8+2" },
        "4": { "难度": "18", "攻击命中": "+4", "生命点": "6", "压力点": "4", "重度伤害阈值": "22", "严重伤害阈值": "40", "攻击伤害": "4d10+2" }
    },
    "辅助": {
        "1": { "难度": "13", "攻击命中": "+1", "生命点": "3", "压力点": "4", "重度伤害阈值": "7", "严重伤害阈值": "3", "攻击伤害": "1d8" },
        "2": { "难度": "15", "攻击命中": "+2", "生命点": "4", "压力点": "5", "重度伤害阈值": "10", "严重伤害阈值": "8", "攻击伤害": "2d8+1" },
        "3": { "难度": "17", "攻击命中": "+3", "生命点": "5", "压力点": "5", "重度伤害阈值": "17", "严重伤害阈值": "31", "攻击伤害": "3d8" },
        "4": { "难度": "19", "攻击命中": "+4", "生命点": "6", "压力点": "5", "重度伤害阈值": "22", "严重伤害阈值": "40", "攻击伤害": "3d10+3" }
    }
};

const TRAIT_LIBRARY = [
    { name: "无情（X）", type: "被动", desc: "在每个游戏主持人轮次中，此敌人可以至多被聚焦 X 次。像往常一样花费恐惧点来聚焦。" },
    { name: "集群（X/生命点）", type: "被动", desc: "当集群标记了其生命点的一半或更多时，其标准攻击造成的伤害改为 Y。" },
    { name: "杂兵（X）", type: "被动", desc: "当此敌人受到任何伤害时，即被击败。玩家角色每对此敌人造成 X 点伤害，则在攻击能够成功命中的范围内额外击败一个杂兵。" },
    { name: "群体攻击", type: "动作", desc: "花费 1 恐惧点，选择一个目标，并聚焦目标附近特定范围内的所有同名敌人。这些杂兵移动到目标的近战范围内，并进行一次共享攻击掷骰。成功时，他们每人造成 X 点伤害。将这些伤害合并计算。" },

    { name: "乘胜追击", type: "反应", desc: "当此敌人成功命中玩家角色时，你获得 1 恐惧点。" },
    { name: "惊怖", type: "被动", desc: "当此敌人成功攻击时，所有近距离范围内的玩家角色失去 1 希望点，而你获得 1 恐惧点。" },
    { name: "蓄力", type: "被动", desc: "你必须花费 1 恐惧点来聚焦此敌人。当被聚焦时，其可以对范围内所有目标进行普通攻击。" },
    { name: "迟缓", type: "被动", desc: "当你聚焦此敌人，且其数据块上没有指示物时，它无法立即行动。在它的数据块上放置一个标记，并描述它正在准备做什么。当你聚焦此敌人，且其数据块上有指示物时，移除指示物，它才可以行动。" },
    
    { name: "激活盟友", type: "动作", desc: "花费X恐惧点以聚焦1d4名盟友。以此方式被聚焦期间，他们发动的攻击造成半数伤害。" },
    { name: "呼叫援军", type: "动作", desc: "每场景一次，标记1压力点以召唤<另一名敌人>，其出现在<指定>范围内。" },
    { name: "战术家", type: "动作", desc: "当你聚焦此敌人时，标记1压力点可同时聚焦近距离范围内的两名盟友。" },
    { name: "无情（1）", type: "被动", desc: "当此敌人被聚焦时，可额外聚焦一名盟友且无需花费恐惧点。" },
    { name: "机会主义者", type: "被动", desc: "当两个或更多敌人位于一个生物的邻近范围内时，此敌人对该生物造成的所有伤害翻倍。" },
    
    { name: "直接伤害", type: "动作", desc: "若目标或此敌人拥有状态，此敌人造成的伤害转为直接伤害。" },
    { name: "伺机射击", type: "反应", desc: "当其他敌人在此敌人的远距离范围内对目标造成伤害时，你可标记1压力点为该伤害掷骰附加<额外伤害>。" },
    { name: "多重打击", type: "反应", desc: "花费1恐惧点对远距离范围内的#个目标发动攻击。此敌人成功命中的目标受到<削减后伤害>。" },
    { name: "隐匿无踪", type: "动作", desc: "进入 隐藏 状态直至下次攻击。通过此特性在处于 隐藏 状态下发动的攻击具有优势。" },
    { name: "伏击", type: "动作", desc: "处于 隐匿 状态时，对<指定>范围内的目标发动攻击。成功时造成<强化后伤害>点物理伤害。" },
    { name: "触发负面效果倒计时", type: "反应", desc: "倒计时（循环1d6）。当<倒计时触发条件>满足时，启动倒计时。触发时此敌人<执行强力行动（发动攻击/迫使进行反应掷骰）>。所有<成功命中/未能通过>的目标将承受负面后果。" },
    { name: "寡不敌众", type: "被动", desc: "当此敌人处于某生物的近战范围内，且至少另一名此敌人处于该生物的近距离范围内时，所有对该生物的攻击均获得优势。" },
    { name: "群体战术", type: "被动", desc: "如果此敌人进行一次成功的普通攻击，且另一个此敌人在目标的近战范围内，则造成 1d6+5 点物理伤害，而非其普通伤害，并且你获得 1 恐惧点。" },
    { name: "范围控制", type: "动作", desc: "花费 1 恐惧点对邻近范围内的所有目标发动攻击。此敌人成功命中的目标将因<剧情中的具体描述>陷入束缚与脆弱状态。目标可通过成功的属性掷骰挣脱，同时解除两种状态。" },
    { name: "破甲打击", type: "动作", desc: "当此敌人攻击成功时，目标必须标记 1 护甲槽，且不获得其效果（其仍然可以使用护甲来减少伤害）。如果目标无法标记护甲槽，则必须额外标记 1 生命点。" },
    { name: "条件增伤", type: "被动", desc: "当此敌人因<特定原因或状态>成功发动普通攻击时，造成<更高伤害>点物理伤害而非普通伤害。" },
    { name: "施加状态", type: "动作", desc: "<执行导致临时状态的动作>。目标获得<状态名称>状态。受此状态影响的目标<状态效果描述>，<状态持续时间或解除方式>。" },
    { name: "幽灵形态", type: "被动", desc: "此敌人具有物理伤害抗性。标记 1 压力点可穿越固体移动至近距离范围。" },
    { name: "心神扰乱", type: "被动", desc: "玩家角色攻击此敌人时若掷出恐惧结果，需标记 1 压力点。" },
    { name: "飞行", type: "被动", desc: "处于飞行状态时，此敌人的难度获得 +3 加值。" }
];

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('enemyForm');
    const traitsContainer = document.getElementById('traitsContainer');
    const addTraitBtn = document.getElementById('addTraitBtn');
    const traitTemplate = document.getElementById('traitTemplate');
    const clearBtn = document.getElementById('clearBtn');
    const applyTemplateBtn = document.getElementById('applyTemplateBtn');

    // 初始化特性项（填充 select 等）
    function initTraitItem(item) {
        const select = item.querySelector('.trait-name-select');
        if (select) {
            // 填充选项
            TRAIT_LIBRARY.forEach(trait => {
                const option = document.createElement('option');
                option.value = trait.name;
                option.textContent = trait.name;
                select.appendChild(option);
            });

            // 绑定事件
            select.addEventListener('change', function() {
                const traitName = this.value;
                const traitData = TRAIT_LIBRARY.find(t => t.name === traitName);
                if (traitData) {
                    item.querySelector('.trait-name').value = traitData.name;
                    item.querySelector('.trait-type').value = traitData.type;
                    item.querySelector('.trait-desc').value = traitData.desc;
                }
                // 重置 select 选中项
                this.selectedIndex = 0;
            });
        }
    }

    // 添加特性
    addTraitBtn.addEventListener('click', () => {
        const clone = traitTemplate.content.cloneNode(true);
        const item = clone.querySelector('.trait-item');
        initTraitItem(item);
        traitsContainer.appendChild(clone);
    });

    // 删除特性 (事件委托)
    traitsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-trait')) {
            e.target.closest('.trait-item').remove();
        }
    });

    // 清空表单
    clearBtn.addEventListener('click', () => {
        if(confirm('确定要清空所有内容吗？')) {
            form.reset();
            traitsContainer.innerHTML = '';
            // 清空后添加一个默认的空特性
            addTraitBtn.click();
        }
    });

    // 应用模板
    if (applyTemplateBtn) {
        applyTemplateBtn.addEventListener('click', () => {
            const tier = document.getElementById('tier').value.trim();
            const category = document.getElementById('category').value.trim();

            if (!tier || !category) {
                alert('请先填写位阶和种类');
                return;
            }

            const categoryData = ENEMY_TEMPLATES[category];
            if (!categoryData) {
                alert(`未找到种类 "${category}" 的模板数据`);
                return;
            }

            const data = categoryData[tier];
            if (!data) {
                alert(`未找到种类 "${category}" 位阶 "${tier}" 的模板数据`);
                return;
            }

            // 填充数据
            document.getElementById('difficulty').value = data['难度'] || '';
            document.getElementById('attackHit').value = data['攻击命中'] || '';
            document.getElementById('hp').value = data['生命点'] || '';
            document.getElementById('stress').value = data['压力点'] || '';
            document.getElementById('majorThreshold').value = data['重度伤害阈值'] || '';
            document.getElementById('severeThreshold').value = data['严重伤害阈值'] || '';
            document.getElementById('attackDamage').value = data['攻击伤害'] || '';

            alert('模板数据已应用');
        });
    }

    // 暴露数据收集函数
    window.collectEnemyEditorData = function() {
        const formData = new FormData(form);
        const enemyData = {
            "名称": formData.get('名称') || "",
            "原文": "",
            "位阶": formData.get('位阶') || "",
            "种类": formData.get('种类') || "",
            "来源": formData.get('来源') || "自定义",
            "特性": [],
            "类型": "敌人",
            "简介": formData.get('简介') || "",
            "动机与战术": formData.get('动机与战术') || "",
            "难度": formData.get('难度') || "",
            "重度伤害阈值": formData.get('重度伤害阈值') || "",
            "严重伤害阈值": formData.get('严重伤害阈值') || "",
            "生命点": formData.get('生命点') || "",
            "压力点": formData.get('压力点') || "",
            "攻击命中": formData.get('攻击命中') || "",
            "攻击武器": formData.get('攻击武器') || "",
            "攻击范围": formData.get('攻击范围') || "",
            "攻击伤害": formData.get('攻击伤害') || "",
            "攻击属性": formData.get('攻击属性') || "",
            "经历": formData.get('经历') || ""
        };

        // 处理特性
        const traitItems = traitsContainer.querySelectorAll('.trait-item');
        traitItems.forEach(item => {
            const trait = {
                "名称": item.querySelector('.trait-name').value || "",
                "原名": "",
                "类型": item.querySelector('.trait-type').value || "",
                "特性描述": item.querySelector('.trait-desc').value || ""
            };
            // 只有当特性有名称时才添加
            if (trait["名称"]) {
                enemyData["特性"].push(trait);
            }
        });
        
        return enemyData;
    };
    
    // 初始化添加一个特性框
    addTraitBtn.click();
});