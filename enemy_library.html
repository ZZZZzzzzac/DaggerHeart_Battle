<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>敌人库模块</title>
    <link rel="stylesheet" href="enemy_editor.css">
    <link rel="stylesheet" href="enemy_card.css">
    <link rel="stylesheet" href="enemy_library.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-family: sans-serif;
        }

        #library-wrapper {
            width: 320px;
            height: 100%;
            flex-shrink: 0;
        }

        #main-content {
            flex: 1;
            padding: 20px;
            background-color: #e9ecef;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }

        .preview-title {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 10px;
            width: 100%;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- 左侧敌人库 -->
    <div id="library-wrapper"></div>

    <!-- 右侧内容区 (战斗面板占位/预览) -->
    <div id="main-content">
        <div class="preview-title">卡片预览</div>
        <div id="preview-area">
            <p style="color:#888;">请在左侧点击列表项以预览卡片，或右键点击列表项进行编辑。</p>
        </div>
    </div>

    <!-- 编辑器模态框 -->
    <div id="editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="editor-injection-point"></div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="敌人数据块.js"></script>
    <script src="enemy_card.js"></script>
    <script src="enemy_editor_template.js"></script>
    <script src="enemy_library.js"></script>
    
    <script>
        // 1. 注入编辑器 HTML
        if (typeof ENEMY_EDITOR_HTML !== 'undefined') {
            document.getElementById('editor-injection-point').innerHTML = ENEMY_EDITOR_HTML;
        }

        // 2. 加载编辑器逻辑 (需要在注入后)
    </script>
    <script src="enemy_editor.js"></script>

    <script>
        // 3. 初始化页面逻辑
        const modal = document.getElementById('editor-modal');
        const closeModal = document.querySelector('.close-modal');
        const previewArea = document.getElementById('preview-area');
        const enemyForm = document.getElementById('enemyForm');

        let currentEditingIndex = -1; // -1 表示新建

        // 初始化敌人库
        const library = new EnemyLibrary('library-wrapper', {
            // 选择回调：显示预览
            onSelect: (enemyData) => {
                previewArea.innerHTML = '';
                const card = renderEnemyCard(enemyData);
                previewArea.appendChild(card);
            },
            // 新建回调：打开编辑器
            onRequestNew: () => {
                currentEditingIndex = -1;
                resetEditor();
                modal.style.display = 'block';
            },
            // 编辑回调：打开编辑器并填充
            onRequestEdit: (enemyData, index) => {
                currentEditingIndex = index;
                fillEditor(enemyData);
                modal.style.display = 'block';
            }
        });

        // 模态框关闭
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // 填充编辑器 (复用之前 test.html 的逻辑)
        function fillEditor(data) {
            document.getElementById('name').value = data['名称'] || '';
            document.getElementById('tier').value = data['位阶'] || '';
            document.getElementById('category').value = data['种类'] || '';
            document.getElementById('source').value = data['来源'] || '';
            document.getElementById('intro').value = data['简介'] || '';
            document.getElementById('tactics').value = data['动机与战术'] || '';
            document.getElementById('experiences').value = data['经历'] || '';
            document.getElementById('difficulty').value = data['难度'] || '';
            document.getElementById('hp').value = data['生命点'] || '';
            document.getElementById('stress').value = data['压力点'] || '';
            document.getElementById('majorThreshold').value = data['重度伤害阈值'] || '';
            document.getElementById('severeThreshold').value = data['严重伤害阈值'] || '';
            document.getElementById('attackHit').value = data['攻击命中'] || '';
            document.getElementById('attackWeapon').value = data['攻击武器'] || '';
            document.getElementById('attackRange').value = data['攻击范围'] || '';
            document.getElementById('attackDamage').value = data['攻击伤害'] || '';
            document.getElementById('attackAttr').value = data['攻击属性'] || '';

            // 特性
            const traitsContainer = document.getElementById('traitsContainer');
            const addTraitBtn = document.getElementById('addTraitBtn');
            traitsContainer.innerHTML = '';
            
            if (data['特性']) {
                data['特性'].forEach(trait => {
                    addTraitBtn.click();
                    const items = traitsContainer.querySelectorAll('.trait-item');
                    const newItem = items[items.length - 1];
                    if (newItem) {
                        newItem.querySelector('.trait-name').value = trait['名称'] || '';
                        newItem.querySelector('.trait-type').value = trait['类型'] || '';
                        newItem.querySelector('.trait-desc').value = trait['特性描述'] || '';
                    }
                });
            }
        }

        // 重置编辑器
        function resetEditor() {
            document.getElementById('enemyForm').reset();
            document.getElementById('traitsContainer').innerHTML = '';
            document.getElementById('addTraitBtn').click(); // Add one empty trait
        }

        // 保存编辑器数据
        if (enemyForm) {
            enemyForm.addEventListener('submit', (e) => {
                // enemy_editor.js handles preventDefault logic for its own logging, but we intervene here.
                // We don't need to preventDefault again if it's already done, but it doesn't hurt.
                
                const formData = new FormData(enemyForm);
                const newData = {
                    "名称": formData.get('名称'),
                    "位阶": formData.get('位阶'),
                    "种类": formData.get('种类'),
                    "来源": formData.get('来源'),
                    "简介": formData.get('简介'),
                    "动机与战术": formData.get('动机与战术'),
                    "经历": formData.get('经历'),
                    "难度": formData.get('难度'),
                    "生命点": formData.get('生命点'),
                    "压力点": formData.get('压力点'),
                    "重度伤害阈值": formData.get('重度伤害阈值'),
                    "严重伤害阈值": formData.get('严重伤害阈值'),
                    "攻击命中": formData.get('攻击命中'),
                    "攻击武器": formData.get('攻击武器'),
                    "攻击范围": formData.get('攻击范围'),
                    "攻击伤害": formData.get('攻击伤害'),
                    "攻击属性": formData.get('攻击属性'),
                    "特性": []
                };

                const traitItems = document.getElementById('traitsContainer').querySelectorAll('.trait-item');
                traitItems.forEach(item => {
                    const name = item.querySelector('.trait-name').value;
                    if (name) {
                        newData['特性'].push({
                            '名称': name,
                            '类型': item.querySelector('.trait-type').value,
                            '特性描述': item.querySelector('.trait-desc').value
                        });
                    }
                });

                // 保存到库
                library.saveEnemy(newData, currentEditingIndex);
                
                modal.style.display = 'none';
                
                // 如果是编辑当前预览的卡片，更新预览
                if (currentEditingIndex >= 0) {
                    previewArea.innerHTML = '';
                    previewArea.appendChild(renderEnemyCard(newData));
                }
            });
        }

    </script>
</body>
</html>
