<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>匕首之心战斗面板</title>
    <link rel="stylesheet" href="css/enemy_editor.css">
    <link rel="stylesheet" href="css/enemy_card.css">
    <link rel="stylesheet" href="css/enemy_library.css">
    <link rel="stylesheet" href="css/enemy_library_online.css">
    <link rel="stylesheet" href="css/battle_panel.css">
</head>
<body>

    <!-- Toggle Button -->
    <div id="toggle-library-btn" title="切换敌人库">▶</div>
    <div id="toggle-env-library-btn" title="切换环境库">◀</div>

    <!-- 左侧敌人库 -->
    <div id="library-wrapper" class="library-container">
        <div class="library-header">
            <div class="library-title">
                <span>敌人库</span>
                <span style="font-size:0.8em;color:#666;" id="lib-count">0</span>
                

                            <div class="sort-controls">
                排序:
                <button class="sort-btn" data-sort="位阶">位阶</button> |
                <button class="sort-btn" data-sort="种类">种类</button> |
                <button class="sort-btn" data-sort="来源">来源</button>
            </div>
            </div>
            <div class="library-actions">
                <button class="lib-btn primary" id="lib-btn-new">新建</button>
                <button class="lib-btn" id="lib-btn-export">导出所有</button>
                <button class="lib-btn" id="lib-btn-export-current" title="导出当前筛选结果">导出当前</button>
                <label class="lib-btn" style="text-align:center; margin:0;">
                    导入 <input type="file" id="lib-file-import" style="display:none;" accept=".json">
                </label>
            </div>
            <div class="filter-section">
                <input type="text" class="search-input" id="lib-search" placeholder="搜索名称...">
                <div class="filter-row">
                    <select class="filter-select" id="lib-filter-source" title="筛选来源">
                        <option value="">所有来源</option>
                        <!-- 动态填充 -->
                    </select>
                    <select class="filter-select" id="lib-filter-tier" title="筛选位阶">
                        <option value="">所有位阶</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                    <select class="filter-select" id="lib-filter-category" title="筛选种类">
                        <option value="">所有种类</option>
                        <option value="标准">标准</option>
                        <option value="杂兵">杂兵</option>
                        <option value="头目">头目</option>
                        <option value="独狼">独狼</option>
                        <option value="斗士">斗士</option>
                        <option value="远程">远程</option>
                        <option value="潜伏">潜伏</option>
                        <option value="社交">社交</option>
                        <option value="辅助">辅助</option>
                        <option value="集群">集群</option>
                    </select>
                </div>
            </div>

        </div>
        <div class="enemy-list" id="lib-list">
            <!-- 列表内容 -->
        </div>
    </div>

    <!-- 右侧战斗面板 -->
    <div id="battle-panel">
        <div id="battle-toolbar">
            <div class="toolbar-group">
                <label>PC数量: <input type="number" id="pc-count" value="4" min="1"></label>
                <span id="battle-budget" class="point-display" title="战斗点数 = (3 × PC数) + 2">战斗点数: --</span>
                <span id="current-points" class="point-display">当前: 0</span>
            </div>
            <!-- Online Controls (Centered) -->
            <div id="online-controls" class="online-controls">
                <div class="user-badge">
                    <div id="online-status-dot" class="status-dot offline"></div>
                    <span id="online-username">离线</span>
                </div>
                <button id="btn-online-download" class="btn secondary btn-online" title="刷新云端数据">下载</button>
                <button id="btn-online-upload" class="btn primary btn-online hidden" title="上传本地数据">上传</button>
                <button id="btn-online-auth" class="btn primary btn-online">登录</button>
            </div>
            <div class="toolbar-group">
                <button id="btn-clear-battle" class="btn secondary danger" title="清空面板">清空</button>
                <label class="btn secondary" title="导入面板">
                    <span>导入</span>
                    <input type="file" id="file-import-battle" style="display:none;" accept=".json">
                </label>
                <button id="btn-export-battle" class="btn secondary" title="导出面板">导出</button>
            </div>
        </div>
        <div id="battle-area">
            <div class="empty-tip">点左侧开启敌人库<br>点右侧开启环境库<br>点击或拖拽到此处<br>右键卡片修改数据<br>手机长按修改数据<br>登录后可上传分享</div>
        </div>
    </div>

    <!-- 右侧环境库 -->
    <div id="env-library-wrapper" class="library-container">
        <div class="library-header">
            <div class="library-title">
                <span>环境库</span>
                <span style="font-size:0.8em;color:#666;" id="env-lib-count">0</span>
                <div class="sort-controls">
                    排序:
                    <button class="sort-btn" data-sort="位阶">位阶</button> |
                    <button class="sort-btn" data-sort="种类">种类</button> |
                    <button class="sort-btn" data-sort="来源">来源</button>
                </div>
            </div>
            <div class="library-actions">
                <button class="lib-btn primary" id="env-lib-btn-new">新建</button>
                <button class="lib-btn" id="env-lib-btn-export">导出所有</button>
                <button class="lib-btn" id="env-lib-btn-export-current" title="导出当前筛选结果">导出当前</button>
                <label class="lib-btn" style="text-align:center; margin:0;">
                    导入 <input type="file" id="env-lib-file-import" style="display:none;" accept=".json">
                </label>
            </div>
            <div class="filter-section">
                <input type="text" class="search-input" id="env-lib-search" placeholder="搜索名称...">
                <div class="filter-row">
                    <select class="filter-select" id="env-lib-filter-source" title="筛选来源">
                        <option value="">所有来源</option>
                    </select>
                    <select class="filter-select" id="env-lib-filter-tier" title="筛选位阶">
                        <option value="">所有位阶</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                    <select class="filter-select" id="env-lib-filter-category" title="筛选种类">
                        <option value="">所有种类</option>
                        <option value="险境">险境</option>
                        <option value="地点">地点</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="enemy-list" id="env-lib-list">
            <!-- 列表内容 -->
        </div>
    </div>

    <!-- Online Login Modal -->
    <div id="online-login-modal" class="modal-overlay">
        <div class="modal-content-online">
            <h3 class="modal-title">云端账号</h3>
            <div class="form-group-online">
                <label>邮箱</label>
                <input type="email" id="online-email" placeholder="email@example.com">
            </div>
            <div class="form-group-online">
                <label>密码</label>
                <input type="password" id="online-password" placeholder="******">
            </div>
            <div class="modal-buttons">
                <button id="btn-do-login" class="btn primary" style="flex:1;">登录</button>
                <button id="btn-do-signup" class="btn secondary" style="flex:1;">注册</button>
            </div>
            <div class="modal-buttons">
                <button id="btn-close-online-modal" class="btn danger" style="border:none; width:100%;">关闭</button>
            </div>
        </div>
    </div>

    <!-- 编辑器模态框 -->
    <div id="editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="editor-content">
                <div class="editor-container">
                    <form id="enemyForm">
                        <!-- 基本信息 -->
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="name">名称</label>
                                    <input type="text" id="name" name="名称" required>
                                </div>
                                <div class="form-group">
                                    <label for="tier">位阶</label>
                                    <input type="text" id="tier" name="位阶" required>
                                    <select class="dropdown-trigger" title="选择位阶" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                        <option value="" disabled selected></option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="form-group">
                                    <label for="category">种类</label>
                                    <input type="text" id="category" name="种类">
                                    <select id="category-select" class="dropdown-trigger" title="选择种类" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                        <option value="" disabled selected></option>
                                        <option value="斗士">斗士</option>
                                        <option value="集群">集群</option>
                                        <option value="头目">头目</option>
                                        <option value="杂兵">杂兵</option>
                                        <option value="远程">远程</option>
                                        <option value="潜伏">潜伏</option>
                                        <option value="社交">社交</option>
                                        <option value="独狼">独狼</option>
                                        <option value="标准">标准</option>
                                        <option value="辅助">辅助</option>
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="form-group">
                                    <label for="source">来源</label>
                                    <input type="text" id="source" name="来源">
                                </div>
                                <div class="form-group" style="flex: 0 0 auto;">
                                    <button type="button" id="applyTemplateBtn" class="btn secondary" style="height: 100%; margin: 0; padding: 0 15px;">使用模板</button>
                                </div>
                            </div>
            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="intro">简介</label>
                                    <input type="text" id="intro" name="简介" placeholder="对敌人的外观和举止的概述。">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="tactics">动机与战术</label>
                                    <input type="text" id="tactics" name="动机与战术" placeholder="例如：饥饿、觅食">
                                </div>
                                <div class="form-group">
                                    <label for="experiences">经历</label>
                                    <input type="text" id="experiences" name="经历" placeholder="例如：疾行+2">
                                </div>
                            </div>
            
            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="difficulty">难度</label>
                                    <input type="text" id="difficulty" name="难度">
                                </div>
                                 <div class="form-group">
                                    <label for="hp">生命点</label>
                                    <input type="text" id="hp" name="生命点">
                                </div>
                                <div class="form-group">
                                    <label for="stress">压力点</label>
                                    <input type="text" id="stress" name="压力点">
                                </div>
                                <div class="form-group">
                                    <label for="majorThreshold">阈值</label>
                                    <input type="text" id="majorThreshold" name="重度伤害阈值" placeholder="重度">
                                    <input type="text" id="severeThreshold" name="严重伤害阈值" placeholder="严重">
                                </div>
                            </div>
            
            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="attackHit">攻击</label>
                                    <input type="text" id="attackHit" name="攻击命中" placeholder="命中">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="attackWeapon" name="攻击武器" placeholder="武器">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="attackRange" name="攻击范围" placeholder="范围">
                                    <select class="dropdown-trigger" title="选择攻击范围" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                        <option value="" disabled selected></option>
                                        <option value="近战">近战</option>
                                        <option value="邻近">邻近</option>
                                        <option value="近">近</option>
                                        <option value="远">远</option>
                                        <option value="极远">极远</option>
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="attackDamage" name="攻击伤害" placeholder="伤害骰">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="attackAttr" name="攻击属性" placeholder="属性">
                                    <select class="dropdown-trigger" title="选择攻击属性" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                        <option value="" disabled selected></option>
                                        <option value="物理">物理</option>
                                        <option value="魔法">魔法</option>
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                            </div>
                        </div>
            
                        <!-- 特性 -->
                        <div class="form-section">
                            <div id="traitsContainer">
                                <!-- 特性条目将在这里动态生成 -->
                            </div>
                        </div>
            
                        <div class="form-actions">
                            <button type="button" id="addTraitBtn" class="btn secondary">+ 添加特性</button>
                            <button type="submit" class="btn primary">确定</button>
                            <button type="button" id="saveAsBtn" class="btn primary">另存为</button>
                            <button type="button" id="clearBtn" class="btn danger">清空</button>
                        </div>
                    </form>
                </div>
                
                <!-- 特性模板 -->
                <template id="traitTemplate">
                    <div class="trait-item">
                        <div class="form-row">
                            <div class="form-group">
                                <label>特性名称</label>
                                <input type="text" class="trait-name" name="特性名称" placeholder="特性名称" required>
                                <select class="dropdown-trigger trait-name-select" title="选择特性">
                                    <option value="" disabled selected></option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="form-group">
                                <label>特性类型</label>
                                <input type="text" class="trait-type" name="特性类型" placeholder="被动/动作/反应">
                                <select class="dropdown-trigger" title="选择特性类型" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                    <option value="" disabled selected></option>
                                    <option value="被动">被动</option>
                                    <option value="动作">动作</option>
                                    <option value="反应">反应</option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <button type="button" class="btn-icon remove-trait" title="删除">×</button>
                        </div>
                        <div class="form-group">
                            <label>特性描述</label>
                            <textarea class="trait-desc" name="特性描述" rows="2" placeholder="特性描述"></textarea>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- 环境编辑器模态框 -->
    <div id="environment-editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="environment-editor-content">
                <div class="editor-container">
                    <form id="environmentForm">
                        <!-- 基本信息 -->
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="env-name">名称</label>
                                    <input type="text" id="env-name" name="名称" required>
                                </div>
                                <div class="form-group">
                                    <label for="env-tier">位阶</label>
                                    <input type="text" id="env-tier" name="位阶" required>
                                    <select class="dropdown-trigger" title="选择位阶" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                        <option value="" disabled selected></option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="form-group">
                                    <label for="env-category">种类</label>
                                    <input type="text" id="env-category" name="种类">
                                    <select id="env-category-select" class="dropdown-trigger" title="选择种类" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                        <option value="" disabled selected></option>
                                        <option value="险境">险境</option>
                                        <option value="险境">探索</option>
                                        <option value="险境">事件</option>
                                        <option value="险境">社交</option>
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="form-group">
                                    <label for="env-source">来源</label>
                                    <input type="text" id="env-source" name="来源">
                                </div>
                            </div>
            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="env-intro">简介</label>
                                    <input type="text" id="env-intro" name="简介" placeholder="对环境的外观和氛围的概述。">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="env-tendency">趋向</label>
                                    <input type="text" id="env-tendency" name="趋向" placeholder="环境的倾向或目的">
                                </div>
                                <div class="form-group">
                                    <label for="env-potential-enemies">潜在敌人</label>
                                    <input type="text" id="env-potential-enemies" name="潜在敌人" placeholder="在此环境中可能遭遇的敌人">
                                </div>
                            </div>
            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="env-difficulty">难度</label>
                                    <input type="text" id="env-difficulty" name="难度">
                                </div>
                            </div>
                        </div>
            
                        <!-- 特性 -->
                        <div class="form-section">
                            <div id="envTraitsContainer">
                                <!-- 特性条目将在这里动态生成 -->
                            </div>
                        </div>
            
                        <div class="form-actions">
                            <button type="button" id="addEnvTraitBtn" class="btn secondary">+ 添加特性</button>
                            <button type="submit" class="btn primary">确定</button>
                            <button type="button" id="envSaveAsBtn" class="btn primary">另存为</button>
                            <button type="button" id="clearEnvBtn" class="btn danger">清空</button>
                        </div>
                    </form>
                </div>
                
                <!-- 环境特性模板 -->
                <template id="envTraitTemplate">
                    <div class="trait-item">
                        <div class="form-row">
                            <div class="form-group">
                                <label>特性名称</label>
                                <input type="text" class="trait-name" name="特性名称" placeholder="特性名称" required>
                                <select class="dropdown-trigger trait-name-select" title="选择特性">
                                    <option value="" disabled selected></option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="form-group">
                                <label>特性类型</label>
                                <input type="text" class="trait-type" name="特性类型" placeholder="被动/动作/反应">
                                <select class="dropdown-trigger" title="选择特性类型" onchange="this.previousElementSibling.value=this.value; this.selectedIndex=0;">
                                    <option value="" disabled selected></option>
                                    <option value="被动">被动</option>
                                    <option value="动作">动作</option>
                                    <option value="反应">反应</option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <button type="button" class="btn-icon remove-trait" title="删除">×</button>
                        </div>
                        <div class="form-group">
                            <label>特性描述</label>
                            <textarea class="trait-desc" name="特性描述" rows="2" placeholder="特性描述"></textarea>
                        </div>
                        <div class="form-group">
                            <label>特性问题</label>
                            <textarea class="trait-question" name="特性问题" rows="2" placeholder="针对该特性的提问"></textarea>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="data/核心书.js"></script>
    <script src="data/VOID.js"></script>
    <script src="js/enemy_card.js"></script>
    <script src="js/environment_card.js"></script>
    <script src="js/enemy_editor.js"></script>
    <script src="js/environment_editor.js"></script>
    <script src="js/enemy_library.js?v=2"></script>
    <script src="js/environment_library.js"></script>
    <script src="js/battle_panel.js?v=2"></script>
    
    <!-- Online Features -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/enemy_library_online.js?v=2"></script>

</body>
</html>
